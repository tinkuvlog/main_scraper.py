<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarkari Naukri Finder - Latest Jobs, Results & Admit Cards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .job-card, .result-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .job-card:hover, .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .skeleton-loader {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .btn-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .tab-btn.active {
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-20">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-briefcase text-2xl text-indigo-600"></i>
                <h1 class="text-xl md:text-2xl font-bold text-gray-900">Sarkari Naukri Finder</h1>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">

        <!-- Hero Section -->
        <section class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-3">Find Your Dream Government Job</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">Your one-stop portal for the latest jobs, results, and admit cards.</p>
            <div class="mt-8 max-w-xl mx-auto">
                <div class="relative">
                    <input type="search" id="searchInput" placeholder="Search across all sections..." class="w-full p-4 pr-12 text-gray-900 border border-gray-300 rounded-full bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    <button class="absolute inset-y-0 right-0 flex items-center pr-4">
                        <i class="fas fa-search text-gray-400"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- Main Content Area with Tabs -->
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md border border-gray-200">
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex flex-wrap gap-4" aria-label="Tabs">
                    <button data-tab="jobs" class="tab-btn active whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm">
                        <i class="fas fa-briefcase mr-2"></i>Latest Jobs
                    </button>
                    <button data-tab="results" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-indigo-600">
                        <i class="fas fa-poll mr-2"></i>Results
                    </button>
                    <button data-tab="admitCards" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-indigo-600">
                        <i class="fas fa-id-card mr-2"></i>Admit Cards
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div>
                <!-- Jobs Content -->
                <div id="jobs-content" class="tab-content">
                    <div id="jobs-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                    <div id="jobs-skeleton-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                    <div id="jobs-load-more-container" class="text-center mt-8"></div>
                </div>
                <!-- Results Content -->
                <div id="results-content" class="tab-content hidden">
                    <div id="results-container" class="space-y-4"></div>
                    <div id="results-skeleton-container" class="space-y-4"></div>
                    <div id="results-load-more-container" class="text-center mt-8"></div>
                </div>
                <!-- Admit Cards Content -->
                <div id="admitCards-content" class="tab-content hidden">
                    <div id="admit-cards-container" class="space-y-4"></div>
                    <div id="admit-cards-skeleton-container" class="space-y-4"></div>
                    <div id="admit-cards-load-more-container" class="text-center mt-8"></div>
                </div>
            </div>
        </div>
        
        <!-- AI Sections Grid -->
        <section id="ai-tools" class="mt-12">
             <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center"><i class="fas fa-robot mr-3 text-indigo-500"></i>AI Preparation Tools</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div id="career-advisor" class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900 mb-2 flex items-center"><i class="fas fa-user-graduate mr-3 text-indigo-500"></i>AI Career Advisor</h3>
                    <p class="text-gray-600 mb-4">Enter your qualifications to get personalized job suggestions from our AI.</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="qualificationInput" placeholder="E.g., B.Tech, 12th Pass" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <button id="getAdviceBtn" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center">
                            <span id="adviceBtnText">✨ Get Advice</span>
                            <div id="adviceBtnSpinner" class="hidden btn-spinner"></div>
                        </button>
                    </div>
                    <div id="adviceResult" class="mt-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-lg text-gray-700 hidden"></div>
                </div>
                <div id="quiz-hub" class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900 mb-2 flex items-center"><i class="fas fa-book-open mr-3 text-purple-500"></i>Current Affairs Hub</h3>
                    <p class="text-gray-600 mb-4">Test your knowledge with a fresh quiz on recent events, generated by AI.</p>
                    <button id="getQuizBtn" class="w-full bg-purple-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center">
                        <span id="quizBtnText">✨ Generate Monthly Quiz</span>
                        <div id="quizBtnSpinner" class="hidden btn-spinner"></div>
                    </button>
                    <div id="quiz-container" class="mt-4 text-gray-700 hidden"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
            <p>&copy; 2025 Sarkari Naukri Finder. All Rights Reserved.</p>
            <p class="text-sm text-gray-400 mt-2">Disclaimer: This website is not an official government portal. We collect information from various official sources to provide timely updates.</p>
        </div>
    </footer>

    <!-- AI Modal -->
    <div id="aiModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-30 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col modal-content">
            <div class="p-4 border-b flex justify-between items-center">
                <h4 id="aiModalTitle" class="text-xl font-bold text-gray-800"></h4>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="modalBody" class="p-6 overflow-y-auto"></div>
            <div id="modalFooter" class="p-4 bg-gray-50 border-t"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy, limit, getDocs, startAfter } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const searchInput = document.getElementById('searchInput');
        const aiModal = document.getElementById('aiModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');
        const aiModalTitle = document.getElementById('aiModalTitle');
        const qualificationInput = document.getElementById('qualificationInput');
        const getAdviceBtn = document.getElementById('getAdviceBtn');
        const adviceBtnText = document.getElementById('adviceBtnText');
        const adviceBtnSpinner = document.getElementById('adviceBtnSpinner');
        const adviceResult = document.getElementById('adviceResult');
        const getQuizBtn = document.getElementById('getQuizBtn');
        const quizBtnText = document.getElementById('quizBtnText');
        const quizBtnSpinner = document.getElementById('quizBtnSpinner');
        const quizContainer = document.getElementById('quiz-container');
        const tabButtons = document.querySelectorAll('.tab-btn');

        // --- App State ---
        let db;
        let allData = { jobs: [], results: [], admitCards: [] };
        let lastVisible = { jobs: null, results: null, admitCards: null };
        const itemsPerPage = 12;
        let appId = 'my-job-porta';
        let quizData = []; 

        // --- Firebase and App Initialization ---
        async function setupApp() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyBmJN7DL7d8G1ByqPKdzIBpNZxSp4-0VrI",
                    authDomain: "my-job-porta.firebaseapp.com",
                    projectId: "my-job-porta",
                    storageBucket: "my-job-porta.firebasestorage.app",
                    messagingSenderId: "246539623451",
                    appId: "1:246539623451:web:483fd691916b7ba6a7ecbe",
                    measurementId: "G-9S4CR1KR5Q"
                };
                appId = firebaseConfig.projectId;
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, user => {
                    if (user) {
                        loadInitialData();
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('jobs-container').innerHTML = `<p class="text-red-500 col-span-full">Error: Could not connect to the database.</p>`;
            }
        }
        
        // --- Data Loading and Rendering ---
        async function loadInitialData() {
            showSkeletons();
            await Promise.all([
                fetchAndRenderData('jobs'),
                fetchAndRenderData('results'),
                fetchAndRenderData('admitCards')
            ]);
            hideSkeletons();
        }

        async function fetchAndRenderData(type, loadMore = false) {
            const container = document.getElementById(`${type}-container`);
            const loadMoreContainer = document.getElementById(`${type}-load-more-container`);
            
            if (!container || !loadMoreContainer) return;
            
            if (!loadMore) {
                container.innerHTML = '';
                allData[type] = [];
                lastVisible[type] = null;
            }

            let q = query(
                collection(db, `artifacts/${appId}/public/data/${type}`), 
                orderBy("postedDate", "desc"), 
                limit(itemsPerPage)
            );

            if (loadMore && lastVisible[type]) {
                q = query(q, startAfter(lastVisible[type]));
            }

            try {
                const documentSnapshots = await getDocs(q);
                
                if (documentSnapshots.empty && !loadMore) {
                    container.innerHTML = `<p class="text-gray-500 p-4">No new ${type} found.</p>`;
                }
                
                lastVisible[type] = documentSnapshots.docs[documentSnapshots.docs.length - 1];

                let itemsHtml = '';
                documentSnapshots.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    allData[type].push(data);
                    if (type === 'jobs') {
                        itemsHtml += createJobCard(data);
                    } else {
                        itemsHtml += createResultCard(data);
                    }
                });
                container.innerHTML += itemsHtml;
                
                if (documentSnapshots.docs.length === itemsPerPage) {
                    loadMoreContainer.innerHTML = `<button data-type="${type}" class="load-more-btn bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-indigo-700">Load More</button>`;
                } else {
                    loadMoreContainer.innerHTML = '';
                }

            } catch (error) {
                console.error(`Error fetching ${type}:`, error);
                container.innerHTML = `<p class="text-red-500 p-4">Error loading ${type}.</p>`;
            }
        }
        
        function sanitizeText(text) {
            if (!text) return '';
            return text.replace(/`/g, "'").replace(/\r/g, '');
        }

        function createJobCard(job) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const lastDate = new Date(job.lastDate);
            lastDate.setHours(0, 0, 0, 0);

            if (lastDate < today) return ''; // Don't show expired jobs

            const formattedDate = lastDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            const statusHtml = `<div class="flex items-center font-semibold text-gray-700"><i class="fas fa-calendar-alt w-5 text-center mr-2 text-red-500"></i><span><strong>Last Date:</strong> ${formattedDate}</span></div>`;

            return `
                <div class="job-card bg-white p-6 rounded-lg shadow-md border border-gray-200 flex flex-col">
                    <h4 class="text-lg font-bold text-gray-900">${sanitizeText(job.title)}</h4>
                    <p class="text-sm text-gray-500 mb-4">${sanitizeText(job.organization)}</p>
                    <div class="space-y-3 text-gray-700 text-sm flex-grow">
                        <div class="flex items-center"><i class="fas fa-briefcase w-5 text-center mr-2 text-indigo-500"></i><span><strong>Vacancies:</strong> ${sanitizeText(job.vacancies)}</span></div>
                        <div class="flex items-center"><i class="fas fa-graduation-cap w-5 text-center mr-2 text-indigo-500"></i><span><strong>Qualification:</strong> ${sanitizeText(job.education)}</span></div>
                        ${statusHtml}
                    </div>
                    <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center flex-wrap gap-2">
                         <button data-jobid="${job.id}" class="summarize-btn bg-blue-100 text-blue-800 font-semibold px-3 py-2 rounded-lg hover:bg-blue-200 transition-colors text-xs">✨ Quick Summary</button>
                         <button data-jobid="${job.id}" class="details-btn bg-indigo-600 text-white font-semibold px-3 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm">View Details</button>
                    </div>
                </div>`;
        }

        function createResultCard(item) {
            return `
                <a href="${item.url}" target="_blank" class="result-card block bg-white p-3 rounded-lg shadow-md border border-gray-200">
                    <p class="font-semibold text-indigo-700 hover:underline">${sanitizeText(item.title)}</p>
                </a>
            `;
        }

        function showSkeletons() {
            let skeleton = '<div class="skeleton-loader bg-white p-6 rounded-lg shadow-md border border-gray-200 h-48"></div>';
            document.getElementById('jobs-skeleton-container').innerHTML = skeleton.repeat(6);
            let smallSkeleton = '<div class="skeleton-loader bg-white p-3 rounded-lg shadow-md border border-gray-200 h-12"></div>';
            document.getElementById('results-skeleton-container').innerHTML = smallSkeleton.repeat(5);
            document.getElementById('admit-cards-skeleton-container').innerHTML = smallSkeleton.repeat(5);
        }
        
        function hideSkeletons() {
            document.getElementById('jobs-skeleton-container').innerHTML = '';
            document.getElementById('results-skeleton-container').innerHTML = '';
            document.getElementById('admit-cards-skeleton-container').innerHTML = '';
        }

        // --- Gemini API Integration ---
        async function callGeminiAPI(prompt, isJson = false) {
            const apiKey = ""; // Leave empty
            const model = 'gemini-2.0-flash';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            if (isJson) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || null;
                return text;
            } catch (error) {
                console.error("Gemini API error:", error);
                return null;
            }
        }

        function showModal(title, bodyContent, footerContent = '') {
            aiModalTitle.innerHTML = title;
            modalBody.innerHTML = bodyContent;
            modalFooter.innerHTML = footerContent;
            aiModal.classList.remove('hidden');
        }

        function formatForDisplay(text) {
            if (!text) return "";
            let html = sanitizeText(text)
                .replace(/## (.*)/g, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/(?:^\* .*(?:\n|$))+/gm, (listBlock) => {
                const listItems = listBlock.trim().split('\n').map(item => `<li>${item.replace(/^\* /, '').trim()}</li>`).join('');
                return `<ul>${listItems}</ul>`;
            });
            return html.replace(/\n/g, '<br>');
        }

        async function handleSummarizeClick(jobId) {
            const job = allData.jobs.find(j => j.id === jobId);
            if (!job) return;
            showModal('✨ AI Generated Summary', `<div class="flex items-center justify-center p-8"><div class="btn-spinner" style="width: 40px; height: 40px;"></div><p class="ml-4">Generating summary...</p></div>`);
            const prompt = `Summarize this government job notification into 5-6 clear bullet points. Focus on the most critical info: Post Name, Vacancies, Eligibility, Last Date, and Selection Process. Notification: --- ${sanitizeText(job.notificationText)} ---. Format as Markdown using '*' for bullet points.`;
            const summary = await callGeminiAPI(prompt);
            showModal('✨ AI Generated Summary', formatForDisplay(summary));
        }

        async function handleDetailsClick(jobId) {
            const job = allData.jobs.find(j => j.id === jobId);
            if (!job) return;

            const footerLinks = `
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <a href="${job.applicationUrl}" target="_blank" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors w-full sm:w-auto"><i class="fas fa-paper-plane mr-2"></i>Apply Online</a>
                    <a href="${job.notificationPdfUrl}" target="_blank" class="bg-gray-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-800 transition-colors w-full sm:w-auto"><i class="fas fa-file-pdf mr-2"></i>Download Notification</a>
                    <button data-jobid="${job.id}" class="study-plan-btn bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors w-full sm:w-auto">✨ Create Study Plan</button>
                </div>`;

            if (job.detailedSummary) {
                showModal(`Details for ${job.title}`, formatForDisplay(job.detailedSummary), footerLinks);
                return;
            }

            showModal(`Details for ${job.title}`, `<div class="flex items-center justify-center p-8"><div class="btn-spinner" style="width: 40px; height: 40px;"></div><p class="ml-4">Fetching and formatting details...</p></div>`, '');

            const prompt = `You are an expert at parsing Indian government job notifications. From the following text, extract and structure the information into these specific sections using Markdown. Be comprehensive and clear.
            ## Key Information
            * **Post Name**: ${sanitizeText(job.title)}
            * **Vacancies**: ${sanitizeText(job.vacancies)}
            * **Salary / Pay Scale**: [Extract Pay Scale]
            * **Age Limit**: [Extract Age Limit, including any relaxation details]
            * **Application Fee**: [Extract Fee Details for all categories]
            ## Important Dates
            * **Application Start**: [Extract Start Date]
            * **Application End**: ${job.lastDate}
            * **Exam Date**: [Extract Exam Date]
            ## Educational Qualifications
            [Extract detailed educational requirements here as bullet points.]
            ## Selection Process
            [Extract the stages of the selection process as an ordered or unordered list.]
            ## Syllabus Outline
            [Provide a detailed syllabus outline based on the text. Use nested bullet points for subjects and topics.]
            Notification Text: --- ${sanitizeText(job.notificationText)} ---`;

            const details = await callGeminiAPI(prompt);
            
            try {
                const jobRef = doc(db, `artifacts/${appId}/public/data/jobs`, job.id);
                await updateDoc(jobRef, { detailedSummary: details });
                job.detailedSummary = details;
            } catch (error) {
                console.error("Error caching details:", error);
            }
            
            showModal(`Details for ${job.title}`, formatForDisplay(details), footerLinks);
        }

        async function handleCreateStudyPlan(jobId) {
            const job = allData.jobs.find(j => j.id === jobId);
            if (!job) return;
            showModal(`✨ AI Study Plan for ${job.title}`, `<div class="flex items-center justify-center p-8"><div class="btn-spinner" style="width: 40px; height: 40px;"></div><p class="ml-4">Generating your personalized study plan...</p></div>`, '');
            const prompt = `You are an expert exam coach for Indian government jobs. Create a comprehensive 4-week study plan for the "${sanitizeText(job.title)}" exam based on its notification. The plan should be structured, actionable, and easy to follow. Break it down week-by-week and day-by-day. For each day, specify the subjects and key topics to cover from the syllabus. Include time for revision and mock tests. Format the entire output as clean Markdown.
            
            Notification Text:
            ---
            ${sanitizeText(job.notificationText)}
            ---`;
            const plan = await callGeminiAPI(prompt);
            showModal(`✨ AI Study Plan for ${job.title}`, formatForDisplay(plan), '');
        }
        
        async function handleGetAdvice() {
            const qualification = qualificationInput.value.trim();
            if (!qualification) {
                adviceResult.textContent = "Please enter your qualification.";
                adviceResult.classList.remove('hidden');
                return;
            }
            adviceBtnText.classList.add('hidden');
            adviceBtnSpinner.classList.remove('hidden');
            getAdviceBtn.disabled = true;

            const prompt = `I am a student in India with this qualification: "${qualification}". Act as a friendly career counselor for government jobs. Suggest 3-5 specific jobs or exam categories I am eligible for, explain why, and give a simple next step for each. Format as Markdown.`;
            const advice = await callGeminiAPI(prompt);
            adviceResult.innerHTML = formatForDisplay(advice);
            adviceResult.classList.remove('hidden');
            
            adviceBtnText.classList.remove('hidden');
            adviceBtnSpinner.classList.add('hidden');
            getAdviceBtn.disabled = false;
        }

        async function handleGenerateQuiz() {
            quizBtnText.classList.add('hidden');
            quizBtnSpinner.classList.remove('hidden');
            getQuizBtn.disabled = true;
            quizContainer.classList.remove('hidden');
            quizContainer.innerHTML = `<div class="flex items-center justify-center p-4"><div class="btn-spinner"></div><p class="ml-3">Generating quiz...</p></div>`;

            const prompt = `Create a 5-question multiple-choice quiz on Indian current affairs from the last month, relevant to government exams. Return the output as a valid JSON array of objects. Each object must have three keys: "question" (string), "options" (an array of 4 strings), and "answer" (the 0-indexed integer of the correct option).`;
            
            const rawJson = await callGeminiAPI(prompt, true);
            if (!rawJson) {
                quizContainer.innerHTML = `<p class="text-red-500">Failed to generate quiz. Please try again.</p>`;
                quizBtnText.classList.remove('hidden');
                quizBtnSpinner.classList.add('hidden');
                getQuizBtn.disabled = false;
                return;
            }

            try {
                quizData = JSON.parse(rawJson);
                let quizHtml = '<div id="quiz-score" class="mb-4 text-center"></div><form id="quiz-form">';
                quizData.forEach((q, index) => {
                    quizHtml += `<div class="mb-6">
                        <p class="font-bold mb-2">${index + 1}. ${q.question}</p>
                        <div class="space-y-2">`;
                    q.options.forEach((option, optionIndex) => {
                        quizHtml += `<label for="q${index}o${optionIndex}" class="block p-3 border border-gray-300 rounded-lg hover:bg-gray-100 cursor-pointer quiz-option">
                            <input type="radio" name="question${index}" id="q${index}o${optionIndex}" value="${optionIndex}" class="mr-2">
                            ${option}
                        </label>`;
                    });
                    quizHtml += `</div></div>`;
                });
                quizHtml += `<button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700">Submit Test</button></form>`;
                quizContainer.innerHTML = quizHtml;

                document.getElementById('quiz-form').addEventListener('submit', handleSubmitQuiz);
            } catch (e) {
                console.error("Failed to parse quiz JSON:", e);
                quizContainer.innerHTML = `<p class="text-red-500">Error displaying quiz. The AI returned an invalid format.</p>`;
            }

            quizBtnText.classList.remove('hidden');
            quizBtnSpinner.classList.add('hidden');
            getQuizBtn.disabled = false;
        }

        function handleSubmitQuiz(e) {
            e.preventDefault();
            let score = 0;
            const form = e.target;
            
            quizData.forEach((q, index) => {
                const selectedOption = form.querySelector(`input[name="question${index}"]:checked`);
                const options = form.querySelectorAll(`input[name="question${index}"]`);

                options.forEach(opt => opt.disabled = true); // Disable all options

                const correctLabel = form.querySelector(`label[for="q${index}o${q.answer}"]`);
                correctLabel.classList.add('correct');

                if (selectedOption) {
                    const selectedValue = parseInt(selectedOption.value);
                    if (selectedValue === q.answer) {
                        score++;
                    } else {
                        const selectedLabel = form.querySelector(`label[for="${selectedOption.id}"]`);
                        selectedLabel.classList.add('incorrect');
                    }
                }
            });

            const scoreDiv = document.getElementById('quiz-score');
            scoreDiv.innerHTML = `<h4 class="text-2xl font-bold text-indigo-600">You Scored: ${score} / ${quizData.length}</h4>`;
            form.querySelector('button[type="submit"]').style.display = 'none';
        }

        // --- Event Listeners ---
        document.body.addEventListener('click', (e) => {
            if (e.target.classList.contains('load-more-btn')) {
                const type = e.target.dataset.type;
                fetchAndRenderData(type, true);
            }
        });

        jobListingsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const jobId = button.dataset.jobid;
            if (button.classList.contains('summarize-btn')) handleSummarizeClick(jobId);
            if (button.classList.contains('details-btn')) handleDetailsClick(jobId);
        });
        modalFooter.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if(button && button.classList.contains('study-plan-btn')) {
                const jobId = button.dataset.jobid;
                handleCreateStudyPlan(jobId);
            }
        });
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                
                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.add('text-gray-500', 'hover:text-indigo-600');
                });
                button.classList.add('active');
                button.classList.remove('text-gray-500', 'hover:text-indigo-600');

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tab}-content`).classList.remove('hidden');
            });
        });

        closeModalBtn.addEventListener('click', () => aiModal.classList.add('hidden'));
        aiModal.addEventListener('click', (e) => { if (e.target === aiModal) aiModal.classList.add('hidden'); });
        getAdviceBtn.addEventListener('click', handleGetAdvice);
        getQuizBtn.addEventListener('click', handleGenerateQuiz);
        window.addEventListener('load', setupApp);

    </script>
</body>
</html>
